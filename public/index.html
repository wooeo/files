<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Files System</title>
    <link rel="stylesheet" href="index.css">
</head>
<body>
    <div class="container">
        <h1>Files System</h1>
        <div class="card-upload">
            <div class="upload-form-row">
                <input type="file" id="fileInput" multiple style="display:none;">
                <input type="file" id="folderInput" multiple webkitdirectory style="display:none;">
                <button type="button" class="upload-btn" onclick="document.getElementById('fileInput').click()">é€‰æ‹©æ–‡ä»¶</button>
                <button type="button" class="upload-btn" onclick="document.getElementById('folderInput').click()">é€‰æ‹©æ–‡ä»¶å¤¹</button>
                <select id="subdirSelect" class="upload-select">
                    <option value="">æ ¹ç›®å½•</option>
                    <option value="videos">Videos</option>
                    <option value="audios">Audios</option>
                    <option value="pictures">Pictures</option>
                    <option value="documents">Documents</option>
                    <option value="others">Others</option>
                </select>
                <button type="button" class="upload-btn" onclick="triggerUpload()">å¼€å§‹ä¸Šä¼ </button>
            </div>
            <div id="selectedFiles" class="selected-files-box"></div>
            <div id="uploadStatus"></div>
        </div>
        <div class="file-list-toolbar" style="display:flex;align-items:center;gap:10px;">
            <button id="backBtn" style="display:none;" onclick="goBackDir()">â¬… è¿”å›ä¸Šçº§ç›®å½•</button>
            <button id="batchDeleteBtn" disabled onclick="batchDelete()">æ‰¹é‡åˆ é™¤</button>
            <button id="batchMoveBtn" disabled onclick="batchMove()">æ‰¹é‡ç§»åŠ¨</button>
            <span class="file-list-title">File List</span>
            <select id="filterSubdir" onchange="fetchFiles()">
                <option value="">All Directories</option>
                <option value="">æ ¹ç›®å½•</option>
                <option value="videos">Videos</option>
                <option value="audios">Audios</option>
                <option value="pictures">Pictures</option>
                <option value="documents">Documents</option>
                <option value="others">Others</option>
            </select>
            <button class="refresh-btn" onclick="fetchFiles()">åˆ·æ–°åˆ—è¡¨</button>
        </div>
        <div class="table-wrapper">
            <table id="fileTable">
                <thead>
                    <tr>
                        <th><input type="checkbox" id="selectAll"></th>
                        <th>Name</th>
                        <th>Directory</th>
                        <th>Type</th>
                        <th>Size</th>
                        <th>Last Modified</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <!-- é‡å‘½åæ¨¡æ€æ¡† -->
    <div id="renameModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>Rename File</h3>
            <input type="text" id="newFileName" placeholder="Enter new filename">
            <button onclick="confirmRename()">Rename</button>
        </div>
    </div>

    <!-- ç§»åŠ¨æ¨¡æ€æ¡† -->
    <div id="moveModal" class="modal">
        <div class="modal-content">
            <span class="close-move">&times;</span>
            <h3>Move File</h3>
            <select id="moveTargetDir"></select>
            <button onclick="confirmMove()">Move</button>
        </div>
    </div>

    <!-- å…¨å±€ä¸­é—´æç¤º -->
    <div id="toast" class="toast" style="display:none;"></div>

    <script>
        let currentXhr = null; // å…¨å±€å˜é‡ä¿å­˜å½“å‰xhr
        let currentFileForRename = null; // å½“å‰è¦é‡å‘½åçš„æ–‡ä»¶
        let currentFileForMove = null; // å½“å‰è¦ç§»åŠ¨çš„æ–‡ä»¶
        let lastInputId = null;

        // è·å–æ–‡ä»¶åˆ—è¡¨
        async function fetchFiles() {
            try {
                const filterSubdir = document.getElementById('filterSubdir').value;
                document.getElementById('backBtn').style.display = filterSubdir ? '' : 'none';
                const url = filterSubdir ? `/api/files?subdir=${filterSubdir}` : '/api/files';
                const response = await fetch(url);
                const files = await response.json();
                const tableBody = document.querySelector('#fileTable tbody');
                tableBody.innerHTML = '';
                
                if (files.length === 0) {
                    const row = document.createElement('tr');
                    const cell = document.createElement('td');
                    cell.colSpan = 5;
                    cell.textContent = 'No files found';
                    cell.style.textAlign = 'center';
                    row.appendChild(cell);
                    tableBody.appendChild(row);
                    return;
                }
                
                const folderOrder = ['videos', 'audios', 'pictures', 'documents', 'others'];
                files.sort((a, b) => {
                    if (a.isDirectory && b.isDirectory) {
                        return folderOrder.indexOf(a.name) - folderOrder.indexOf(b.name);
                    } else if (a.isDirectory) {
                        return -1;
                    } else if (b.isDirectory) {
                        return 1;
                    } else {
                        return 0;
                    }
                });
                
                window.currentFiles = files;
                
                files.forEach((file, idx) => {
                    const row = document.createElement('tr');
                    
                    // å¤é€‰æ¡†åˆ—
                    const checkboxCell = document.createElement('td');
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.className = 'row-checkbox';
                    checkbox.dataset.index = idx;
                    checkbox.onclick = updateBatchToolbar;
                    checkboxCell.appendChild(checkbox);
                    row.appendChild(checkboxCell);
                    
                    // æ–‡ä»¶ååˆ—
                    const nameCell = document.createElement('td');
                    let icon = '';
                    if (file.isDirectory) {
                        icon = 'ğŸ“ ';
                        const folderLink = document.createElement('a');
                        folderLink.className = 'folder-link';
                        folderLink.textContent = icon + file.name + '/';
                        folderLink.href = '#';
                        folderLink.onclick = function(e) {
                            e.preventDefault();
                            const filterSubdir = document.getElementById('filterSubdir');
                            const newValue = filterSubdir.value ? filterSubdir.value + '/' + file.name : file.name;
                            // å¦‚æœ select æ²¡æœ‰è¿™ä¸ª optionï¼Œåˆ™åŠ¨æ€æ·»åŠ 
                            let found = false;
                            for (let i = 0; i < filterSubdir.options.length; i++) {
                                if (filterSubdir.options[i].value === newValue) {
                                    found = true;
                                    break;
                                }
                            }
                            if (!found) {
                                const opt = document.createElement('option');
                                opt.value = newValue;
                                opt.textContent = newValue;
                                filterSubdir.appendChild(opt);
                            }
                            filterSubdir.value = newValue;
                            fetchFiles();
                        };
                        nameCell.appendChild(folderLink);
                    } else {
                        // åˆ¤æ–­æ–‡ä»¶ç±»å‹
                        const ext = file.name.split('.').pop().toLowerCase();
                        if (["mp4","webm","ogg","mov","m4v","avi"].includes(ext)) icon = 'ğŸ¬ ';
                        else if (["mp3","wav","aac","flac","m4a"].includes(ext)) icon = 'ğŸµ ';
                        else if (["jpg","jpeg","png","gif","bmp","webp","svg"].includes(ext)) icon = 'ğŸ–¼ï¸ ';
                        else if (["doc","docx","pdf","xls","xlsx","ppt","pptx","txt","md","csv"].includes(ext)) icon = 'ğŸ“„ ';
                        else if (["zip","rar","7z","tar","gz"].includes(ext)) icon = 'ğŸ—œï¸ ';
                        else if (["json","yaml","toml"].includes(ext)) icon = 'ğŸ§¾ '
                        else icon = 'ğŸ“¦ ';
                        const link = document.createElement('a');
                        link.href = file.downloadUrl;
                        link.textContent = icon + file.name;
                        link.className = 'file-link';
                        link.target = '_blank';
                        link.onclick = function(e) {
                            const ext = file.name.split('.').pop().toLowerCase();
                            const imageExts = ['jpg','jpeg','png','gif','bmp','webp','svg'];
                            const videoExts = ['mp4','webm','ogg','mov','m4v','avi'];
                            const audioExts = ['mp3','wav','ogg','aac','flac','m4a'];
                            if (imageExts.includes(ext) || videoExts.includes(ext) || audioExts.includes(ext)) {
                                e.preventDefault();
                                window.open(file.downloadUrl, '_blank');
                            }
                        };
                        nameCell.appendChild(link);
                    }
                    
                    // ç›®å½•åˆ—
                    const dirCell = document.createElement('td');
                    dirCell.textContent = file.subdir;
                    
                    // ç±»å‹åˆ—
                    const typeCell = document.createElement('td');
                    typeCell.textContent = file.isDirectory ? 'Folder' : 'File';
                    
                    // å¤§å°åˆ—
                    const sizeCell = document.createElement('td');
                    sizeCell.textContent = file.size;
                    
                    // æ—¥æœŸåˆ—
                    const dateCell = document.createElement('td');
                    dateCell.textContent = new Date(file.lastModified).toLocaleString();
                    
                    // æ“ä½œåˆ—
                    const actionCell = document.createElement('td');
                    const actionBtn = document.createElement('button');
                    actionBtn.textContent = 'â‹¯';
                    actionBtn.className = 'action-btn';
                    actionBtn.onclick = (e) => showActionMenu(e, file);
                    actionCell.appendChild(actionBtn);
                    
                    row.appendChild(nameCell);
                    row.appendChild(dirCell);
                    row.appendChild(typeCell);
                    row.appendChild(sizeCell);
                    row.appendChild(dateCell);
                    row.appendChild(actionCell);
                    tableBody.appendChild(row);
                });

                // å…¨é€‰/åé€‰é€»è¾‘
                const selectAll = document.getElementById('selectAll');
                selectAll.onclick = function() {
                    const checkboxes = document.querySelectorAll('.row-checkbox');
                    checkboxes.forEach(cb => { cb.checked = selectAll.checked; });
                    updateBatchToolbar();
                };
                function updateBatchToolbar() {
                    const checkboxes = document.querySelectorAll('.row-checkbox');
                    const checked = Array.from(checkboxes).filter(cb => cb.checked);
                    document.getElementById('batchDeleteBtn').disabled = checked.length === 0;
                    document.getElementById('batchMoveBtn').disabled = checked.length === 0;
                    // åŒæ­¥å…¨é€‰æ¡†çŠ¶æ€
                    selectAll.checked = checked.length === checkboxes.length && checkboxes.length > 0;
                }

                // æ¸²æŸ“å®Œè¡¨æ ¼åï¼Œä¸»åŠ¨è°ƒç”¨ä¸€æ¬¡ï¼Œç¡®ä¿æŒ‰é’®çŠ¶æ€æ­£ç¡®
                updateBatchToolbar();
            } catch (error) {
                console.error('Error fetching files:', error);
                alert('Error loading file list');
            }
        }

        // æ˜¾ç¤ºæ“ä½œèœå•
        function showActionMenu(event, file) {
            // ç§»é™¤ç°æœ‰çš„èœå•
            const existingMenu = document.querySelector('.action-menu');
            if (existingMenu) {
                existingMenu.remove();
            }

            const menu = document.createElement('div');
            menu.className = 'action-menu';
            document.body.appendChild(menu); // å…ˆåŠ å…¥bodyä»¥ä¾¿è·å–å®½åº¦

            // å…ˆå¡«å……å†…å®¹
            const downloadBtn = document.createElement('div');
            downloadBtn.textContent = 'Download';
            downloadBtn.className = 'menu-item';
            downloadBtn.onclick = () => {
                window.open(file.downloadUrl, '_blank');
                menu.remove();
            };
            const renameBtn = document.createElement('div');
            renameBtn.textContent = 'Rename';
            renameBtn.className = 'menu-item';
            renameBtn.onclick = () => {
                showRenameModal(file);
                menu.remove();
            };
            const deleteBtn = document.createElement('div');
            deleteBtn.textContent = 'Delete';
            deleteBtn.className = 'menu-item delete';
            deleteBtn.onclick = () => {
                deleteFile(file);
                menu.remove();
            };
            const moveBtn = document.createElement('div');
            moveBtn.textContent = 'Move';
            moveBtn.className = 'menu-item';
            moveBtn.onclick = () => {
                showMoveModal(file);
                menu.remove();
            };
            menu.appendChild(downloadBtn);
            menu.appendChild(renameBtn);
            menu.appendChild(deleteBtn);
            menu.appendChild(moveBtn);

            // å®šä½åˆ°æŒ‰é’®æ­£ä¸‹æ–¹å·¦å¯¹é½
            const rect = event.target.getBoundingClientRect();
            menu.style.position = 'fixed';
            menu.style.top = rect.bottom + 'px';
            menu.style.left = rect.left + 'px';
            menu.style.zIndex = '1000';

            // é˜²æ­¢èœå•è¶…å‡ºåº•éƒ¨å’Œå³ä¾§
            setTimeout(() => {
                const menuRect = menu.getBoundingClientRect();
                let newTop = parseInt(menu.style.top);
                let newLeft = parseInt(menu.style.left);
                if (menuRect.bottom > window.innerHeight) {
                    newTop = window.innerHeight - menuRect.height - 10;
                    menu.style.top = newTop + 'px';
                }
                if (menuRect.right > window.innerWidth) {
                    newLeft = window.innerWidth - menuRect.width - 10;
                    menu.style.left = newLeft + 'px';
                }
            }, 0);

            // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­èœå•
            setTimeout(() => {
                document.addEventListener('click', function closeMenu(e) {
                    if (!menu.contains(e.target)) {
                        menu.remove();
                        document.removeEventListener('click', closeMenu);
                    }
                });
            }, 0);
        }

        // æ˜¾ç¤ºé‡å‘½åæ¨¡æ€æ¡†
        function showRenameModal(file) {
            currentFileForRename = file;
            const modal = document.getElementById('renameModal');
            const input = document.getElementById('newFileName');
            input.value = file.name;
            modal.style.display = 'block';
            input.focus();
        }

        // ç¡®è®¤é‡å‘½å
        async function confirmRename() {
            if (!currentFileForRename) return;
            
            const newName = document.getElementById('newFileName').value.trim();
            if (!newName) {
                alert('Please enter a filename');
                return;
            }

            try {
                const oldPath = currentFileForRename.subdir === 'æ ¹ç›®å½•' ? 
                    currentFileForRename.name : 
                    `${currentFileForRename.subdir}/${currentFileForRename.name}`;
                
                const response = await fetch('/api/files/rename', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        oldPath: oldPath,
                        newName: newName
                    })
                });

                const result = await response.json();
                if (response.ok) {
                    alert('File renamed successfully');
                    document.getElementById('renameModal').style.display = 'none';
                    fetchFiles();
                } else {
                    alert('Error: ' + (result.error || 'Rename failed'));
                }
            } catch (error) {
                console.error('Rename error:', error);
                alert('Rename failed');
            }
        }

        // ç›‘å¬ä¸¤ä¸ªinputçš„changeäº‹ä»¶ï¼Œæ˜¾ç¤ºå·²é€‰æ–‡ä»¶å
        function showSelectedFiles(inputId) {
            const fileInput = document.getElementById(inputId);
            const files = fileInput.files;
            const selectedDiv = document.getElementById('selectedFiles');
            if (files.length === 0) {
                selectedDiv.style.display = 'none';
                selectedDiv.innerHTML = '';
                return;
            }
            selectedDiv.style.display = 'block';
            selectedDiv.style.minHeight = '5rem';
            selectedDiv.style.maxHeight = '10rem';
            // åˆ¤æ–­æ˜¯å¦ä¸ºæ–‡ä»¶å¤¹ä¸Šä¼ 
            let folderName = null;
            if (files.length > 0 && files[0].webkitRelativePath) {
                const rel = files[0].webkitRelativePath;
                const topFolder = rel.split('/')[0];
                const allInSameFolder = Array.from(files).every(f => f.webkitRelativePath && f.webkitRelativePath.startsWith(topFolder + '/'));
                if (allInSameFolder) {
                    folderName = topFolder;
                }
            }
            if (folderName) {
                selectedDiv.innerHTML = `<b>å·²é€‰æ–‡ä»¶å¤¹ï¼š</b> <span style="color:#1976d2;font-weight:bold;">${folderName}/</span>`;
            } else {
                const maxShow = 8;
                let html = '<b>å·²é€‰æ–‡ä»¶ï¼š</b><ul style="margin:4px 0 0 0;padding-left:18px;">';
                for (let i = 0; i < Math.min(files.length, maxShow); i++) {
                    html += `<li>${files[i].name}</li>`;
                }
                if (files.length > maxShow) {
                    html += `<li>...ç­‰${files.length}ä¸ªæ–‡ä»¶</li>`;
                }
                html += '</ul>';
                selectedDiv.innerHTML = html;
            }
        }
        document.getElementById('fileInput').addEventListener('change', function() {
            lastInputId = 'fileInput';
            showSelectedFiles('fileInput');
        });
        document.getElementById('folderInput').addEventListener('change', function() {
            lastInputId = 'folderInput';
            showSelectedFiles('folderInput');
        });
        function triggerUpload() {
            if (!lastInputId) {
                alert('è¯·å…ˆé€‰æ‹©æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹');
                return;
            }
            uploadFile(lastInputId);
        }

        // ä¸Šä¼ æ–‡ä»¶ï¼Œå¸¦è¿›åº¦æ¡å’Œå–æ¶ˆ
        async function uploadFile(inputId) {
            const fileInput = document.getElementById(inputId);
            const subdirSelect = document.getElementById('subdirSelect');
            const files = fileInput.files;
            if (files.length === 0) {
                alert('Please select file(s)');
                return;
            }
            const subdir = subdirSelect.value;
            // æ–°å¢ï¼šå¦‚æœæ˜¯æ–‡ä»¶å¤¹ä¸Šä¼ ï¼Œå…ˆåˆ›å»ºé¡¶å±‚æ–‡ä»¶å¤¹
            if (inputId === 'folderInput') {
                const topFolders = new Set();
                for (const file of files) {
                    if (file.webkitRelativePath) {
                        const top = file.webkitRelativePath.split('/')[0];
                        topFolders.add(top);
                    }
                }
                for (const folder of topFolders) {
                    await fetch('/api/create-folder', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ subdir, folderPath: folder })
                    });
                }
            }
            // è¿›åº¦æ¡
            const progressContainer = document.createElement('div');
            progressContainer.className = 'progress-container';
            progressContainer.innerHTML = '<div class="progress-bar" id="progressBar">0%</div>';
            // å–æ¶ˆæŒ‰é’®
            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'å–æ¶ˆ';
            cancelBtn.className = 'cancel-btn';
            cancelBtn.style.marginLeft = '10px';
            let aborted = false;
            cancelBtn.onclick = function() {
                aborted = true;
                progressContainer.remove();
                document.getElementById('uploadStatus').textContent = 'å·²å–æ¶ˆä¸Šä¼ ';
                document.getElementById('selectedFiles').innerHTML = '';
            };
            progressContainer.appendChild(cancelBtn);
            document.querySelector('.card-upload').appendChild(progressContainer);
            const progressBar = document.getElementById('progressBar');
            const statusDiv = document.getElementById('uploadStatus');
            let uploaded = 0;
            for (let i = 0; i < files.length; i++) {
                if (aborted) break;
                await new Promise((resolve) => {
                    const file = files[i];
                    const formData = new FormData();
                    formData.append('file', file, file.name);
                    const url = '/api/upload?subdir=' + encodeURIComponent(subdir) +
                        '&filename=' + encodeURIComponent(utf8ToBase64(file.name)) +
                        (file.webkitRelativePath ? '&relativePath=' + encodeURIComponent(file.webkitRelativePath) : '');
                    const xhr = new XMLHttpRequest();
                    xhr.upload.addEventListener('progress', (event) => {
                        if (event.lengthComputable) {
                            const percent = Math.round((event.loaded / event.total) * 100);
                            progressBar.style.width = percent + '%';
                            progressBar.textContent = `(${i+1}/${files.length}) ` + percent + '%';
                        }
                    });
                    xhr.onload = function() { resolve(); };
                    xhr.onerror = function() { resolve(); };
                    xhr.onabort = function() { resolve(); };
                    cancelBtn.onclick = function() {
                        aborted = true;
                        xhr.abort();
                        progressContainer.remove();
                        document.getElementById('uploadStatus').textContent = 'å·²å–æ¶ˆä¸Šä¼ ';
                        document.getElementById('selectedFiles').innerHTML = '';
                    };
                    xhr.open('POST', url);
                    xhr.send(formData);
                });
                uploaded++;
                progressBar.style.width = '100%';
                progressBar.textContent = `(${uploaded}/${files.length}) 100%`;
            }
            if (!aborted) {
                statusDiv.textContent = 'Upload completed successfully!';
                statusDiv.style.color = '#43a047';
                setTimeout(() => {
                    progressContainer.remove();
                    statusDiv.textContent = '';
                    document.getElementById('selectedFiles').innerHTML = '';
                    // æ–°å¢ï¼šå½»åº•é‡ç½®ä¸Šä¼ åŒºé«˜åº¦å’Œ paddingï¼Œå¹¶ç§»é™¤æ‰€æœ‰è¿›åº¦æ¡ç­‰éè¡¨å•å†…å®¹
                    const cardUpload = document.querySelector('.card-upload');
                    if (cardUpload) {
                        cardUpload.style.minHeight = '120px';
                        cardUpload.style.paddingTop = '30px';
                        cardUpload.style.paddingBottom = '0';
                        // ç§»é™¤æ‰€æœ‰è¿›åº¦æ¡ç­‰éè¡¨å•å†…å®¹
                        const children = Array.from(cardUpload.children);
                        children.forEach(child => {
                            if (child.classList && child.classList.contains('progress-container')) child.remove();
                        });
                    }
                }, 1500);
                fileInput.value = '';
                fetchFiles();
            }
        }

        // åˆ é™¤æ–‡ä»¶
        async function deleteFile(file, silent = false) {
            if (!silent) {
                if (!confirm('Are you sure you want to delete "' + file.name + '"?')) {
                    return;
                }
            }
            try {
                const filePath = file.subdir === 'æ ¹ç›®å½•' ? 
                    file.name : 
                    `${file.subdir}/${file.name}`;
                const response = await fetch('/api/files/' + encodeURIComponent(filePath), {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                const result = await response.json();
                if (response.ok) {
                    showToast('File deleted successfully', 2000);
                    fetchFiles();
                } else {
                    showToast('Error: ' + (result.error || 'Delete failed'), 3000);
                }
            } catch (error) {
                console.error('Delete error:', error);
                showToast('Delete failed', 3000);
            }
        }

        // æ¨¡æ€æ¡†å…³é—­äº‹ä»¶
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('renameModal');
            const span = document.getElementsByClassName('close')[0];
            
            span.onclick = function() {
                modal.style.display = 'none';
            }
            
            window.onclick = function(event) {
                if (event.target == modal) {
                    modal.style.display = 'none';
                }
            }
            
            // å›è½¦é”®ç¡®è®¤é‡å‘½å
            document.getElementById('newFileName').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    confirmRename();
                }
            });
        });

        // åˆå§‹åŠ è½½æ–‡ä»¶åˆ—è¡¨
        fetchFiles();
        
        function utf8ToBase64(str) {
            return btoa(unescape(encodeURIComponent(str)));
        }

        // è¿”å›ä¸Šä¸€çº§ç›®å½•
        function goBackDir() {
            const filterSubdir = document.getElementById('filterSubdir');
            if (!filterSubdir.value) return;
            const arr = filterSubdir.value.split('/');
            arr.pop();
            filterSubdir.value = arr.join('/');
            fetchFiles();
        }

        // å…¨å±€ä¸­é—´æç¤º
        function showToast(msg, duration=2000) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.style.display = 'block';
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
                toast.style.display = 'none';
            }, duration);
        }

        // æ–°å¢ Move æ¨¡æ€æ¡†
        function showMoveModal(file) {
            currentFileForMove = file;
            const modal = document.getElementById('moveModal');
            const select = document.getElementById('moveTargetDir');
            // è·å–æ‰€æœ‰å¯é€‰æ–‡ä»¶å¤¹ï¼ˆä¸å«å½“å‰ç›®å½•ï¼‰
            fetch('/api/subdirs').then(r=>r.json()).then(subdirs=>{
                select.innerHTML = '';
                subdirs.forEach(dir => {
                    if (file.subdir !== dir) {
                        const opt = document.createElement('option');
                        opt.value = dir;
                        opt.textContent = dir;
                        select.appendChild(opt);
                    }
                });
            });
            modal.style.display = 'block';
        }

        function confirmMove() {
            if (!currentFileForMove) return;
            const targetDir = document.getElementById('moveTargetDir').value;
            const oldPath = currentFileForMove.subdir === 'æ ¹ç›®å½•' ? currentFileForMove.name : `${currentFileForMove.subdir}/${currentFileForMove.name}`;
            fetch('/api/files/move', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ oldPath, targetDir })
            }).then(r=>r.json()).then(result=>{
                if (result && result.message) {
                    showToast('File moved successfully', 2000);
                    document.getElementById('moveModal').style.display = 'none';
                    fetchFiles();
                } else {
                    showToast('Move failed: ' + (result.error || ''), 3000);
                }
            }).catch(()=>{
                showToast('Move failed', 3000);
            });
        }

        // å…³é—­æ¨¡æ€æ¡†äº‹ä»¶
        window.addEventListener('DOMContentLoaded', function() {
            const moveModal = document.getElementById('moveModal');
            const closeMove = document.querySelector('.close-move');
            if (closeMove) {
                closeMove.onclick = function() { moveModal.style.display = 'none'; };
            }
            window.onclick = function(event) {
                if (event.target == moveModal) moveModal.style.display = 'none';
            };
        });

        // æ‰¹é‡åˆ é™¤
        async function batchDelete() {
            const checkboxes = document.querySelectorAll('.row-checkbox');
            const checked = Array.from(checkboxes).filter(cb => cb.checked);
            if (checked.length === 0) return;
            if (!confirm('ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ' + checked.length + ' ä¸ªæ–‡ä»¶/æ–‡ä»¶å¤¹å—ï¼Ÿ')) return;
            for (const cb of checked) {
                const idx = cb.dataset.index;
                const file = window.currentFiles[idx];
                if (!file.isDirectory) {
                    await deleteFile(file, true); // silentæ¨¡å¼ï¼Œä¸å†å¼¹çª—
                }
            }
            fetchFiles();
        }

        // æ‰¹é‡ç§»åŠ¨
        function batchMove() {
            const checkboxes = document.querySelectorAll('.row-checkbox');
            const checked = Array.from(checkboxes).filter(cb => cb.checked);
            window.batchMoveFiles = checked.map(cb => window.currentFiles[cb.dataset.index]).filter(f => !f.isDirectory);
            if (window.batchMoveFiles.length === 0) return;
            showBatchMoveModal();
        }

        function showBatchMoveModal() {
            const modal = document.getElementById('moveModal');
            const select = document.getElementById('moveTargetDir');
            // è·å–æ‰€æœ‰å¯é€‰æ–‡ä»¶å¤¹
            fetch('/api/subdirs').then(r=>r.json()).then(subdirs=>{
                select.innerHTML = '';
                subdirs.forEach(dir => {
                    const opt = document.createElement('option');
                    opt.value = dir;
                    opt.textContent = dir;
                    select.appendChild(opt);
                });
            });
            modal.style.display = 'block';
            // ä¿®æ”¹ç¡®è®¤æŒ‰é’®äº‹ä»¶
            const btn = modal.querySelector('button');
            btn.onclick = confirmBatchMove;
        }

        async function confirmBatchMove() {
            const targetDir = document.getElementById('moveTargetDir').value;
            for (const file of window.batchMoveFiles) {
                const oldPath = file.subdir === 'æ ¹ç›®å½•' ? file.name : `${file.subdir}/${file.name}`;
                await fetch('/api/files/move', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ oldPath, targetDir })
                });
            }
            document.getElementById('moveModal').style.display = 'none';
            fetchFiles();
        }
    </script>
</body>
</html>
